name: Deploy Android to Play Store

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.0.1, etc.
  workflow_dispatch:  # Allow manual trigger
    inputs:
      track:
        description: 'Deployment track'
        required: true
        type: choice
        options:
          - internal
          - beta
          - production
        default: 'internal'
      rollout_percentage:
        description: 'Rollout percentage (for production)'
        required: false
        type: string
        default: '0.1'

jobs:
  deploy-android:
    name: Build and Deploy Android
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # ============================================
      # STEP 1: Checkout Code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for version detection

      # ============================================
      # STEP 2: Setup Environment
      # ============================================
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: android

      # ============================================
      # STEP 3: Cache Dependencies
      # ============================================
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ============================================
      # STEP 4: Install Dependencies
      # ============================================
      - name: Install Fastlane
        run: |
          cd android
          gem install bundler
          bundle install

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      # ============================================
      # STEP 5: Configure Signing
      # ============================================
      - name: Decode and setup keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          # Decode keystore from base64
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/keystore.jks

          # Verify keystore exists
          ls -la android/app/keystore.jks

      - name: Create keystore.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cat > android/keystore.properties << EOF
          RELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD
          RELEASE_KEY_PASSWORD=$KEY_PASSWORD
          RELEASE_KEY_ALIAS=$KEY_ALIAS
          RELEASE_STORE_FILE=keystore.jks
          EOF

      # ============================================
      # STEP 6: Run Tests
      # ============================================
      - name: Run unit tests
        run: |
          cd android
          ./gradlew testDebugUnitTest --stacktrace

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-test-results
          path: android/app/build/reports/tests/
          retention-days: 7

      # ============================================
      # STEP 7: Build App Bundle (AAB)
      # ============================================
      - name: Build release AAB
        run: |
          cd android
          ./gradlew bundleRelease --stacktrace

      - name: Sign AAB
        run: |
          cd android
          jarsigner -verbose \
            -sigalg SHA256withRSA \
            -digestalg SHA-256 \
            -keystore app/keystore.jks \
            -storepass ${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.ANDROID_KEY_PASSWORD }} \
            app/build/outputs/bundle/release/app-release.aab \
            ${{ secrets.ANDROID_KEY_ALIAS }}

      - name: Verify AAB signature
        run: |
          cd android
          jarsigner -verify -verbose -certs app/build/outputs/bundle/release/app-release.aab

      # ============================================
      # STEP 8: Deploy to Play Store
      # ============================================
      - name: Setup Play Store credentials
        env:
          PLAY_STORE_JSON_KEY_BASE64: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: |
          echo "$PLAY_STORE_JSON_KEY_BASE64" | base64 -d > android/play-store-key.json

      - name: Deploy to Play Store (Internal Testing)
        if: github.event.inputs.track == 'internal' || github.event.inputs.track == ''
        env:
          SUPPLY_JSON_KEY: ${{ github.workspace }}/android/play-store-key.json
          SKIP_GIT_CHECK: "true"
        run: |
          cd android
          bundle exec fastlane deploy_internal

      - name: Deploy to Play Store (Beta)
        if: github.event.inputs.track == 'beta'
        env:
          SUPPLY_JSON_KEY: ${{ github.workspace }}/android/play-store-key.json
          SKIP_GIT_CHECK: "true"
        run: |
          cd android
          bundle exec fastlane deploy_beta

      - name: Deploy to Play Store (Production)
        if: github.event.inputs.track == 'production'
        env:
          SUPPLY_JSON_KEY: ${{ github.workspace }}/android/play-store-key.json
          SKIP_GIT_CHECK: "true"
          ROLLOUT_PERCENTAGE: ${{ github.event.inputs.rollout_percentage || '0.1' }}
        run: |
          cd android
          bundle exec fastlane deploy_production rollout_percentage:$ROLLOUT_PERCENTAGE

      # ============================================
      # STEP 9: Upload Build Artifacts
      # ============================================
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-aab-${{ github.ref_name }}
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Upload APK artifact (for testing)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-apk-${{ github.ref_name }}
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: android-build-logs-${{ github.ref_name }}
          path: |
            android/app/build/reports/
            android/fastlane/logs/
          retention-days: 7

      # ============================================
      # STEP 10: Cleanup Secrets
      # ============================================
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f android/app/keystore.jks
          rm -f android/keystore.properties
          rm -f android/play-store-key.json

      # ============================================
      # STEP 11: Notify (Optional)
      # ============================================
      - name: Notify deployment success
        if: success()
        run: |
          echo "üéâ Android build successfully deployed to Play Store!"
          echo "Version: ${{ github.ref_name }}"
          echo "Track: ${{ github.event.inputs.track || 'internal' }}"
          echo "Check Play Console for build status."

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Android deployment failed!"
          echo "Check logs for details."
