name: PR Checks

# Hybrid CI/CD Approach:
# - GitHub Actions: Runs automatically only on main branch (production safety net)
# - Local CI: Used for feature branches during development (faster feedback)
# - Manual Trigger: Available for any branch via GitHub Actions UI when needed

on:
  pull_request:  # Run on all PRs, regardless of target branch
  push:
    branches:
      - main  # Only auto-run on pushes to main
  workflow_dispatch:  # Allow manual triggering from GitHub UI for any branch

# Cancel in-progress runs for the same workflow and PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Run both platform checks in parallel
  android-checks:
    name: Android Build & Test
    uses: ./.github/workflows/ci-android.yml
    secrets: inherit

  ios-checks:
    name: iOS Build & Test
    uses: ./.github/workflows/ci-ios.yml
    secrets: inherit

  # Summary job that depends on both platform checks
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [android-checks, ios-checks]
    steps:
      - name: All checks passed
        run: echo "âœ… All platform checks passed successfully!"

  # Post coverage comment on PRs
  coverage-comment:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [android-checks, ios-checks]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coverage data artifact (for baseline comparison)
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: pr-checks.yml
          branch: main
          name: coverage-baseline
          path: baseline/
        continue-on-error: true

      - name: Post Coverage Comment
        uses: actions/github-script@v7
        with:
          script: |
            const iosCoverage = '${{ needs.ios-checks.outputs.coverage }}' || '0.0';
            const androidCoverage = '${{ needs.android-checks.outputs.coverage }}' || '0.0';

            // Try to read baseline from main branch
            let baselineIos = 'â€”';
            let baselineAndroid = 'â€”';
            let iosDiff = '';
            let androidDiff = '';

            const fs = require('fs');
            try {
              if (fs.existsSync('baseline/coverage.json')) {
                const baseline = JSON.parse(fs.readFileSync('baseline/coverage.json', 'utf8'));
                baselineIos = baseline.ios || 'â€”';
                baselineAndroid = baseline.android || 'â€”';

                if (baselineIos !== 'â€”' && iosCoverage !== '0.0') {
                  const diff = parseFloat(iosCoverage) - parseFloat(baselineIos);
                  iosDiff = diff >= 0 ? ` (+${diff.toFixed(1)}%)` : ` (${diff.toFixed(1)}%) âš ï¸`;
                }
                if (baselineAndroid !== 'â€”' && androidCoverage !== '0.0') {
                  const diff = parseFloat(androidCoverage) - parseFloat(baselineAndroid);
                  androidDiff = diff >= 0 ? ` (+${diff.toFixed(1)}%)` : ` (${diff.toFixed(1)}%) âš ï¸`;
                }
              }
            } catch (e) {
              console.log('No baseline found, showing current coverage only');
            }

            const body = `## ğŸ“Š Code Coverage Report

            | Platform | Coverage | vs Main |
            |----------|----------|---------|
            | ğŸ iOS | **${iosCoverage}%** | ${baselineIos !== 'â€”' ? baselineIos + '%' + iosDiff : 'No baseline'} |
            | ğŸ¤– Android | **${androidCoverage}%** | ${baselineAndroid !== 'â€”' ? baselineAndroid + '%' + androidDiff : 'No baseline'} |

            <details>
            <summary>ğŸ“ View detailed reports</summary>

            Download the coverage artifacts from the workflow run:
            - **iOS**: \`ios-coverage-report\`
            - **Android**: \`android-unit-coverage-report\`

            </details>

            ---
            <sub>âš ï¸ = Coverage decreased from main branch</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('ğŸ“Š Code Coverage Report'));

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Save coverage as baseline (on main branch)
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p coverage-baseline
          echo '{"ios": "${{ needs.ios-checks.outputs.coverage }}", "android": "${{ needs.android-checks.outputs.coverage }}"}' > coverage-baseline/coverage.json

      - name: Upload coverage baseline
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-baseline
          path: coverage-baseline/
          retention-days: 90
