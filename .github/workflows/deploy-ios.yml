name: Deploy iOS to TestFlight

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.0.1, etc.
      - '!v*-android'  # Exclude android-only tags
  workflow_dispatch:  # Allow manual trigger
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - testflight
          - appstore
        default: 'testflight'

jobs:
  deploy-ios:
    name: Build and Deploy iOS
    runs-on: macos-26
    timeout-minutes: 60

    steps:
      # ============================================
      # STEP 1: Checkout Code
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for version detection

      # ============================================
      # STEP 2: Setup Environment
      # ============================================
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: ios

      # ============================================
      # STEP 3: Install Dependencies
      # ============================================
      - name: Install Fastlane and xcpretty
        run: |
          cd ios
          gem install bundler
          gem install xcpretty
          bundle install

      # ============================================
      # STEP 4: Configure Signing
      # ============================================
      - name: Import signing certificates
        env:
          CERTIFICATES_P12_BASE64: ${{ secrets.IOS_CERTIFICATES_P12 }}
          CERTIFICATES_PASSWORD: ${{ secrets.IOS_CERTIFICATES_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Decode and import certificate
          echo "$CERTIFICATES_P12_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATES_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          # Set key partition list
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" \
            build.keychain

          # Clean up
          rm certificate.p12

      - name: Import provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          # Create provisioning profiles directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          # Decode and save provisioning profile
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          UUID=$(grep UUID -A1 -a profile.mobileprovision | grep -io "[-A-F0-9]\{36\}")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision

          # Clean up
          rm profile.mobileprovision

      # ============================================
      # STEP 5: Run Tests
      # ============================================
      - name: Run unit tests
        run: |
          cd ios/JustSpent
          xcodebuild test \
            -project JustSpent.xcodeproj \
            -scheme JustSpent \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -only-testing:JustSpentTests \
            | xcpretty --color --simple

      # ============================================
      # STEP 6: Build App
      # ============================================
      - name: Increment build number
        run: |
          cd ios/JustSpent
          BUILD_NUMBER=${{ github.run_number }}
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" JustSpent/Info.plist
          echo "Build number set to: $BUILD_NUMBER"

      - name: Build IPA
        env:
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
          SKIP_GIT_CHECK: "true"
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd ios
          bundle exec fastlane build_ipa

      # ============================================
      # STEP 7: Upload to TestFlight
      # ============================================
      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          echo "$APP_STORE_CONNECT_API_KEY_P8" > ios/AuthKey.p8

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          SKIP_GIT_CHECK: "true"
        run: |
          cd ios
          bundle exec fastlane upload_testflight

      # ============================================
      # STEP 8: Upload Build Artifacts
      # ============================================
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-ipa-${{ github.ref_name }}
          path: ios/build/*.ipa
          retention-days: 30

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ios-build-logs-${{ github.ref_name }}
          path: |
            ios/fastlane/logs
            ~/Library/Logs/gym
          retention-days: 7

      # ============================================
      # STEP 9: Cleanup
      # ============================================
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true

      # ============================================
      # STEP 10: Notify (Optional)
      # ============================================
      - name: Notify deployment success
        if: success()
        run: |
          echo "üéâ iOS build successfully deployed to TestFlight!"
          echo "Version: ${{ github.ref_name }}"
          echo "Check App Store Connect for build status."

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå iOS deployment failed!"
          echo "Check logs for details."
